package client;

import java.util.LinkedList;
import java.util.Random;
import javax.swing.JFrame;
import client.epuck.*;
import tracking.Robot;
import tracking.Vector2d;

/**
 * Main class for the Location Client. It connects to the Location Server,
 * and creates a Controller for the robot, which remotely controls it via Bluetooth.
 * This class also does some extra things, like putting virtual objects in
 * the environment and use that information to provide the robot with
 * virtual sensors.
 *  
 * @author miguelduarte
 */

public class RemoteExperiment extends Thread{
	
	private LocationClient trackerClient;
	private Controller controller;
	private Robot robot;
	private ClientEnvironment environment;
	private PreySensor sensor;
	private long lastPreyTime;
	private long preyTime = 15*1000;
	private int maxNumberOfPreys = 10;
	
	public RemoteExperiment(Controller c, Robot r, ClientEnvironment e) {
		this.controller = c;
		robot = r;
		environment = e;
		sensor = new PreySensor(robot);
		trackerClient = new LocationClient();
		controller.setExperiment(this);
	}
	
	@Override
	public void run() {
		
		System.out.println("Starting experiment");
		
		controller.start();
		
		while(controller.timestep < 1)
			sleep(10);
		
		System.out.println("Successfully started");
		
		lastPreyTime = System.currentTimeMillis();
		
		while(true) {
			
			placePreys();
			
			robot.x = trackerClient.x;
			robot.y = trackerClient.y;
			robot.orientation = trackerClient.orientation;
			
			double[] vals = sensor.update(environment.objects);
			double[] virtual = new double[Controller.INPUTS];
			
			for(int i = 4 ; i < virtual.length ; i++)
				virtual[i] = vals[i-4];
			
			controller.setVirtualInputs(virtual);
			
			sleep(10);
		}
		
	}
	
	private void placePreys() {
		if(System.currentTimeMillis() - lastPreyTime > preyTime && environment.numberOfPreys() < maxNumberOfPreys) {
			
			int minX = 15;
			int maxX = 95;
			int minY = 50;
			int maxY = 120;
			
			double x = (new Random()).nextDouble()*(maxX-minX)+minX;
			double y = (new Random()).nextDouble()*(maxY-minY)+minY;
			
			Robot prey = new Robot();
			prey.x = x;
			prey.y = y;
			prey.orientation = 1;
			
			environment.addObject(prey.getPosition());
			
			trackerClient.sendObjectMessage(prey);
			lastPreyTime = System.currentTimeMillis();
		}
	}
	
	private void sleep(int u) {
		try {
			Thread.sleep(u);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}

	public static void main(String[] args) {
		CTRNNMultilayer ann = new CTRNNMultilayer(12, 10, 3, new int[]{0,1,2,3,4,5,6,7,8,9,10,11}, new double[]{2.149350123395414,-3.5703732956468763,-0.4568823175715303,3.314126557484197,0.8415022250981647,-3.932901494976971,2.8170591157507276,-3.660665796612286,-2.311950668919082,0.8011567676276345,-2.649492861611181,-7.152252094354662,0.0959634981107852,-0.501396038445708,6.624889770180626,1.0826344110305879,1.6435674599777166,1.2565791752335644,-7.859642392844514,2.263554407640915,-2.9006912761578083,-9.889848641879507,4.831452732646521,1.1723866928366862,-2.740767825194327,-2.080216325705893,2.5379554715614714,1.563649052270276,-0.5108960764247863,8.496457381821301,-0.5933930336856528,-3.998967425262116,-4.022763913636365,2.305874023291637,-2.0021155488698286,-2.624858604688276,3.4088245451830774,-0.2961517102124489,-0.8632386731925874,-1.1232261625586684,1.4005767754486236,2.772790727377328,-5.444562473382442,8.394819055731327,3.6317580850379096,-8.451393322382122,2.520791738608965,-1.4028047533833914,1.8879874915787198,-2.2149019837611617,4.640896073614174,-1.255198243436805,3.677406646042499,-8.785274465552016,-2.7761886393073167,0.9438111706629883,-5.091067345113151,4.251555300426813,6.01804319853001,4.022189388890022,-9.211470888460962,-1.3287095393680717,-0.9333287436566209,-7.089973078462477,-2.2173729623415195,0.8138848229007565,-3.8559660175660024,-3.802824378884989,-1.282636822578144,-3.753339863530885,3.5571999409738333,4.460682478791163,1.1090557333423625,-5.740667242736062,2.264802087217488,4.545235412187168,2.7691021099518354,-2.6562952731450835,-2.3461882785783184,2.7822160606854256,-5.1668813136223095,9.920280772738401,2.7328628966838124,9.55776243795652,-3.8491574779931805,1.339963821440132,2.3838676569031185,2.2858023106732253,-7.335833878864319,-6.5569525485151985,0.7871189337593627,1.1129153518638595,-3.843229137271699,-0.3172231229967877,-0.026356361010710982,-0.5953608190513993,-4.551717107341407,-1.7077076211127666,-2.519784653110615,7.259784025373523,-3.3349957550007434,-1.8820333347229634,2.3084443078552077,1.6000110160804057,-1.8707090731575806,-1.8004556455961265,1.0290818882095247,0.996702418745194,0.24151297079087508,2.667466286358008,-2.4573134680051605,-2.763230498660615,0.743194386706763,-2.0881242615131166,-8.027403440314208,3.2204040759697525,3.0276343754637653,-0.4245266015379419,-4.59262887698018,-1.119309834238615,5.610177893477317,-5.4868494055898385,-0.8889575676528714,-2.0344960627536377,-1.137069239972342,-0.30614044295921894,-2.7405183653585494,-1.4506879589431965,-2.146500458544349,-2.900432275793613,-2.4737564535042305,0.20458590563868362,2.194999101658151,2.376286950468109,-6.768101549122498,0.06400847306028812,3.73965657906553,-1.98220697597898,-0.8228704932760028,-8.043577741089939,-2.871973253580711,3.7803916489837204,-3.0401338989069773,-7.358674405445303,-8.531805894422245,2.526675599870261,-6.8705395949974974,-6.0750108865932315,4.468279516895585,-4.53017561014447,3.38548709781211,-6.900805432011728,-2.191467936950552,-9.155845154174092,1.7257380498174326,-0.45167308480293833,4.550470358515897,1.9705263322382907,9.904571802098909,3.6800632366447203,-6.707211483062392,2.888004520450404,6.8933876768960305,-3.8741587080263993,-0.401945623469285,-1.2428725923661792,0.28750495944286203,-5.906527863402694,-3.196008079357025,0.3063984772198197,0.7185540604773188,-6.42450292623523,-1.5913686252167623,-2.850775449792446,-3.090637059010139,-0.43494756107920174,-5.7834909737217535,-1.191853922106875,1.0723784820667441,1.0716953747978544,-3.4050054530700393,-7.590857259789432,-3.9695426977730675,1.6785570103543768,-4.041570797436199,3.654547417851126,-1.975464955051343,-9.794516188783959,-7.397109243475916,0.40521554303819163,-0.7956828734124413,-1.293218533416838,-0.2384423992413388,-3.594884288921489,-8.09225557099003,6.696419616023506,-4.301066778663662,-3.163502136364544,-1.3739556919989269,-1.2049283227344598,-9.387290246031744,4.4897253414244584,-5.849244657766596,1.4293899122221665,-7.1116866180357485,-0.9726946150207194,-5.000377334642805,2.1541516267710925,-0.7430736383784178,1.2806826242774312,-1.4414240793385797,-0.2215372979589969,-1.3120558776250568,1.6446468533125902,1.4218394025262628,-0.8817434789913343,-0.2574943640631837,-3.5467025929324385,0.26237945443248845,0.12061541058831876,-4.666452401337586,1.2191002323205673,-6.565803012398589,-6.606056141159928,-1.6089240763095152,-0.49983943810201664,-1.4889784638663566,-0.9004712572803371,-3.3200444584131406,2.067680038805599,-6.6791294749828305,-2.9529850906858632,-1.8752774644313055,-0.4856507454338732,0.9502076940138078,-6.2985068235327715,-4.975357001409837,-4.534822828612826,1.3666468013343638,-1.5783876348926684,-3.6703904646391035,-2.316695296914311,-8.385521542562067,-0.9448080350624974,-4.052922961913227,5.783437072895962,2.3012665878738097,1.6563209275411919,-3.8591957447817173,0.7391403267107953,-2.291560834766422,-6.576307836659399,-0.8354710896780029,-2.388814027553946,-0.4454699492419958,-6.759151245424424,-1.760654920011304,0.5218787731163098,-1.0094663468406253,0.2744310643686428,-3.482612137588274,4.097416232370543,8.708687700604763,4.6666540148131235,1.1358358975396456,-7.92984958831967,3.2965226186939187,0.6905679825214552,2.9908773304911347,-5.616458047183296,-1.4333557077004868,4.512268065397242,-1.3111655663953061});
		Controller controller = new Controller(ann,12,3);
		ClientEnvironment env = new ClientEnvironment();
		Robot r = new Robot();
		controller.setRobot(r);
		ControllerFrame frame = new ControllerFrame(controller);
		controller.setFrame(frame);
		
		new RemoteExperiment(controller,r,env).start();
	}

	public void removeObject(Vector2d position, int preyPickRange) {
		LinkedList<Vector2d> objs = environment.removeObject(position, preyPickRange);
		for(Vector2d o : objs) {
			Robot r = new Robot();
			r.x = o.x;
			r.y = o.y;
			r.orientation = 0;
			trackerClient.sendObjectMessage(r);
		}
	}
}
