package client;

import java.util.LinkedList;
import java.util.Random;
import javax.swing.JFrame;
import client.epuck.*;
import tracking.Robot;
import tracking.Vector2d;

/**
 * Main class for the Location Client. It connects to the Location Server,
 * and creates a Controller for the robot, which remotely controls it via Bluetooth.
 * This class also does some extra things, like putting virtual objects in
 * the environment and use that information to provide the robot with
 * virtual sensors.
 *  
 * @author miguelduarte
 */

public class RemoteExperiment extends Thread{
	
	private LocationClient trackerClient;
	private Controller controller;
	private Robot robot;
	private ClientEnvironment environment;
	private PreySensor sensor;
	private long lastPreyTime;
	private long preyTime = 15*1000;
	private int maxNumberOfPreys = 10;
	
	public RemoteExperiment(Controller c, Robot r, ClientEnvironment e) {
		this.controller = c;
		robot = r;
		environment = e;
		sensor = new PreySensor(robot);
		trackerClient = new LocationClient();
		controller.setExperiment(this);
	}
	
	@Override
	public void run() {
		
		System.out.println("Starting experiment");
		
		controller.start();
		
		while(controller.timestep < 1)
			sleep(10);
		
		System.out.println("Successfully started");
		
		lastPreyTime = System.currentTimeMillis();
		
		while(true) {
			
			placePreys();
			
			robot.x = trackerClient.x;
			robot.y = trackerClient.y;
			robot.orientation = trackerClient.orientation;
			
			double[] vals = sensor.update(environment.objects);
			double[] virtual = new double[Controller.INPUTS];
			
			for(int i = 4 ; i < virtual.length ; i++)
				virtual[i] = vals[i-4];
			
			controller.setVirtualInputs(virtual);
			
			sleep(10);
		}
		
	}
	
	private void placePreys() {
		if(System.currentTimeMillis() - lastPreyTime > preyTime && environment.numberOfPreys() < maxNumberOfPreys) {
			
			int minX = 15;
			int maxX = 95;
			int minY = 50;
			int maxY = 120;
			
			double x = (new Random()).nextDouble()*(maxX-minX)+minX;
			double y = (new Random()).nextDouble()*(maxY-minY)+minY;
			
			Robot prey = new Robot();
			prey.x = x;
			prey.y = y;
			prey.orientation = 1;
			
			environment.addObject(prey.getPosition());
			
			trackerClient.sendObjectMessage(prey);
			lastPreyTime = System.currentTimeMillis();
		}
	}
	
	private void sleep(int u) {
		try {
			Thread.sleep(u);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}

	public static void main(String[] args) {
		CTRNNMultilayer ann = new CTRNNMultilayer(12, 10, 3, new int[]{0,1,2,3,4,5,6,7,8,9,10,11}, new double[]{2.6530855406704825,-7.234205627264389,-7.016092881472873,-5.50690773491116,-5.668998835522222,-1.3735401627307557,1.3537237030087492,-0.7376291119607488,1.100053831602748,3.1388684854080133,1.1366626123977872,-6.719644072613503,3.039276432468856,3.3967045995515153,-4.000898553568278,1.39817098701235,0.4840961777840788,7.616372478732724,-1.2558974470311568,-4.853654559023532,-7.65773601244952,1.780803999158041,0.29448087708956416,0.5036228602983562,0.3809259104745706,-3.2418916902253843,-4.58315449776285,-4.15975886626231,1.6966245358219818,3.958350059235035,3.6037370729892455,1.120018961028543,0.6259157047585102,-5.746537213295663,0.2090271433682125,-1.6999473948716906,-6.03300641488919,-4.026025134178764,-2.8711274024867492,2.0901424563105047,-5.053560971907559,4.060235998185938,-4.926954393861681,-2.5183182295957924,-3.4466208752545824,1.891622270311573,-4.3382141610433065,3.5627220895870444,0.8446631264700608,0.9819183626365738,1.09934592126855,-0.9804787373559265,-6.027447654446128,3.5853981661327117,-1.0511284262276408,-6.174632431528033,4.044227274947628,-8.51222998651221,0.18321886854731162,-10.0,-5.381190661572653,1.6914668807167954,-1.7423300073001504,-2.3546369502224693,-0.22591737125756528,-1.5048646316166665,-2.142943046689463,1.7920974756862251,8.639784691593395,-1.9977993536510217,0.29549666136345554,-3.309830683090851,-1.033560791668336,0.7217060359724705,-4.002326347254053,-5.344181268611498,-3.7163654781229294,-1.1076717318324998,1.429430401085091,-5.8151677765567165,-2.05805116745457,-0.34433591618059833,0.8866753692367683,-3.420236441574917,-0.48664494062725927,-0.1519611527738255,-1.7600934943632913,-0.5581381622761036,1.2756713706617004,-3.030458044169242,-1.2061896967868597,-4.183454618620328,0.7074869948935283,-1.9132526144986155,2.805113660755466,-1.1288280507151034,3.938013715042508,-0.5712607387375859,0.6352541165255746,4.998402347193192,-1.9866220193407151,-4.056451067887437,0.6790502789319791,1.4184891674591515,-0.05487217667992583,2.1250535877201346,-0.22590781145410907,1.02303088747855,1.3176011642478886,-5.79769020786508,-10.0,4.541121570536461,-4.3179188091233485,-8.109632551817514,1.8505018140046468,-2.039440789640557,-0.681513769226044,-0.16190037471725227,1.1445644065377216,1.9275322940525164,-5.123471589543141,0.5020618838967591,-3.619556930451434,-2.3826352363138428,-2.4913159264763465,-6.772613501061318,1.998518336278408,0.697438301399503,1.6821277408543274,4.024457069208164,-1.8557393099674437,1.4632228809521919,0.6553764453656056,-2.539529379112455,1.8083516910970152,-2.3925618122316887,0.8739847442587987,-8.15291153878858,-4.756331493432766,4.745637636341753,-4.249680690929345,5.23585818266091,-2.9242668173453654,2.4795008152012423,-4.542993831783523,-1.9980341915351365,-1.8349777011684414,-9.092359308525468,-3.4348706859868443,-3.6351928148726116,1.381493883068426,4.252568060438472,2.590318690028781,-2.1066178463469627,-1.1271172007603099,-0.5097447069092675,2.509435681426591,-1.5761975351257018,-3.009713606910477,-3.789818802648379,0.7450020265899377,-3.960999309854887,2.771879270471312,0.9861625496868832,1.17232622792092,-1.5464719972471772,1.545542726702064,3.625827571050147,-1.337754244966519,1.0374173704949952,-0.13315450092585035,-0.45263034627148246,-2.313954196309657,-2.751837789376392,3.385095558439628,-2.843701784113923,-0.8735953153164757,-1.8364156594554037,1.2435401273372375,-2.255905129283441,0.7152958266222551,4.591083799566664,-1.868847723507654,-0.4719947032095039,3.7805875137096487,-1.803999793066052,-5.0735435414830725,1.7641168308971569,-6.445321459913167,-0.8615879290891781,-4.998016296633028,4.680983792053728,-5.025508774721855,-0.7650008754658736,-2.4733191122621427,1.8869036944240396,-2.361983937259062,-0.1335082148805522,0.17430857118618331,-0.20355754660879974,2.4596537039020756,1.7984409361105032,1.3918645314037934,1.046918766135984,-0.9882709306024159,6.14598969423646,-1.6979101956356624,-6.908873467113153,-1.7384157729029424,0.17446062003528073,-5.454365309842437,1.7693971099652317,0.6159197925516321,-0.26103880391854056,-0.7845733478575145,-1.5457704825024658,2.033950637984718,-8.3580169818133,2.132157393972199,-1.268677447641927,-0.8291976730565,0.9339259545987607,1.09575907343448,2.096848153095216,-3.066219498732531,-10.0,0.49076064399485064,-2.745850203024618,-0.6068337762830989,-1.713940987181944,-7.553840863450622,-3.322207612770798,-4.678496086251231,-4.86643023197032,-1.260094606356971,-2.322457743082495,0.5590515347180227,-4.417407653630105,-3.8706732562272075,-5.006205214946571,-0.9363731437050302,-0.61783572866629,1.0613628626376113,-0.8622177694521873,-2.4311906694015493,-4.326450490162079,-1.1981095341542054,0.5365105477767327,-0.006690904069920567,2.218390072594749,1.1025242766932037,1.5298475908969889,2.9253929305845934,6.293924631255982,-0.019049121152979742,-6.173529716230815,-0.9688175937800703,0.24421805866953072,-3.093106934502723,-2.470611559696936,2.031666404748755,1.2204664182976788,-1.8994262427117463,1.2714602960743828,-0.6717161149147783,-0.34165786199873016,-2.042121532801808,4.5828767576138585,-4.916341563557775,-0.26111035868375354,1.3604944872163431,-1.9315280006831803,1.0883286200400044});
		Controller controller = new Controller(ann,12,3);
		ClientEnvironment env = new ClientEnvironment();
		Robot r = new Robot();
		controller.setRobot(r);
		ControllerFrame frame = new ControllerFrame(controller);
		controller.setFrame(frame);
		
		new RemoteExperiment(controller,r,env).start();
	}

	public void removeObject(Vector2d position, int preyPickRange) {
		LinkedList<Vector2d> objs = environment.removeObject(position, preyPickRange);
		for(Vector2d o : objs) {
			Robot r = new Robot();
			r.x = o.x;
			r.y = o.y;
			r.orientation = 0;
			trackerClient.sendObjectMessage(r);
		}
	}
}
